function set_sync_word(e){$.get("/config/lora_config.json",function(e){$("#sync_word").val(e.SyncWord)})}function generate_sync_word(){for(var e=1;e<256;e++)$("#sync_word").append(new Option(e,e))}function get_username(){Socket.send(JSON.stringify({"request-type":"get_username"}))}function send_lora(e){""!=e&&(tx_msg={pack_type:"msg",data:e},$("#lora_msg").val(""),$("#lora_msg").attr("readonly",!0),$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done(function(t){$("#lora_msg").attr("readonly",!1),1==t.akn&&$("#lora_rx_msg").prepend("<li class='list-group-item'>"+t.username+" : "+e+"</li>")}).fail(function(e){$("#lora_msg").attr("readonly",!1)}))}function restart(){$("#promptModalLabel").html("Device Restart"),$("#prompt_body").html("Are you sure you want to restart the device"),promptModal.show(),$("#promptModelProceed").click(function(){promptModal.hide(),Socket.send(JSON.stringify({"request-type":"restart_device"}))})}function get_hostname(){$.get("hostname",function(e){hostname_url="http://"+e+".local/",$("#project_title").attr("href",hostname_url)})}function dashboard(){$(".nav-link").removeClass("active"),$("#navbar-dashboard").addClass("active"),$.get("dashboard.html",function(e){$("#main_content").html(e);var t=transmission;$.get("/config/lora_serial.json",function(e){$("#lora_to_serial").attr("checked",e.lora_serial),t=t||e.lora_serial,block_inputs(t),setTimeout(function(){get_username(),set_sync_word()},10)})})}function file_transfer(){$.get("file_transfer.html",function(e){$("#main_content").html(e);var t=transmission;$.get("/config/lora_serial.json",function(e){t=t||e.lora_serial,block_inputs(t)})})}function wifi(){$(".nav-link").removeClass("active"),$("#navbar-wifi").addClass("active"),$.get("wifi.html",function(e){$("#main_content").html(e),block_inputs(transmission),$.get("/config/wifi_config.json",function(e){$("#wifi_ssid_name").html(e.wifi_ssid)})})}function save_lora_config(){$.get("/config/lora_config.json",function(e){freq=$("#freq_range").val(),tx_power=$("#tx_power_range").val(),s_fact=$("#spreading_factor").val(),bandwidth=$("#bandwidth").val(),coding_rate=$("#coding_rate").val(),sync_word=$("#sync_word").val(),e.freq=parseInt(1e6*freq),e.TxPower=parseInt(tx_power),e.SpreadingFactor=parseInt(s_fact),e.SignalBandwidth=parseInt(bandwidth),e.CodingRate4=parseInt(coding_rate),e.SyncWord=parseInt(sync_word),Socket.send(JSON.stringify({"request-type":"set_lora_config",val:JSON.stringify(e)}))})}function update_lora_config_from_file(){const e=$("#LoraConfigFile").prop("files")[0],t=new FileReader;t.readAsText(e),t.onload=function(e){try{lora_config=JSON.parse(t.result),$("#LoraConfigFile").val(""),set_lora_config(lora_config),alert("Settings applied.<br>Press save to apply.")}catch(e){alert("Invalid file input.")}}}function download_lora_config(){$.get("/config/lora_config.json",function(e){freq=$("#freq_range").val(),tx_power=$("#tx_power_range").val(),s_fact=$("#spreading_factor").val(),bandwidth=$("#bandwidth").val(),coding_rate=$("#coding_rate").val(),sync_word=$("#sync_word").val(),e.freq=parseInt(1e6*freq),e.TxPower=parseInt(tx_power),e.SpreadingFactor=parseInt(s_fact),e.SignalBandwidth=parseInt(bandwidth),e.CodingRate4=parseInt(coding_rate),e.SyncWord=parseInt(sync_word),JSONToFile(e,"project_voyager_lora_config.json")})}function lora(){$(".nav-link").removeClass("active"),$("#navbar-lora").addClass("active"),$.get("lora.html",function(e){$("#main_content").html(e),block_inputs(transmission),$.get("/config/lora_config.json",function(e){generate_sync_word(),$("#freq_range").val(e.freq/1e6),$("#selected_lora_freq").html(e.freq/1e6),$("#tx_power_range").val(e.TxPower),$("#selected_lora_tx_power").html(e.TxPower),$("#spreading_factor").val(e.SpreadingFactor),$("#selected_lora_spreading_factor").html(e.SpreadingFactor),$("#bandwidth").val(e.SignalBandwidth),$("#coding_rate").val(e.CodingRate4),$("#selected_lora_coding_rate").html(e.CodingRate4),$("#sync_word").val(e.SyncWord),$.get("/config/config_list.json",function(e){e.forEach(e=>{$("#lora_config").append('<option value="'+e.value+'">'+e.name+"</option>")})})})})}function set_lora_config(e){generate_sync_word(),$("#freq_range").val(e.freq/1e6),$("#selected_lora_freq").html(e.freq/1e6),$("#tx_power_range").val(e.TxPower),$("#selected_lora_tx_power").html(e.TxPower),$("#spreading_factor").val(e.SpreadingFactor),$("#selected_lora_spreading_factor").html(e.SpreadingFactor),$("#bandwidth").val(e.SignalBandwidth),$("#coding_rate").val(e.CodingRate4),$("#selected_lora_coding_rate").html(e.CodingRate4),$("#sync_word").val(e.SyncWord)}function load_lora_config(e){""!=e&&$.get("/config/"+e,function(e){set_lora_config(e)})}function update(){$(".nav-link").removeClass("active"),$("#navbar-update").addClass("active"),$.get("update",function(e){$("#main_content").html(e),block_inputs(transmission)})}function alert(e){$("#alert_body").html(e),alertModel.show()}function reset(){$("#promptModalLabel").html("Device Reset"),$("#prompt_body").html("Are you sure you want to reset the device ?"),promptModal.show(),$("#promptModelProceed").click(function(){promptModal.hide(),Socket.send(JSON.stringify({"request-type":"reset_device"})),setTimeout(function(){window.location.replace(hostname_url)},1e4)})}function scan_ssid(){$("#wifi_ssid_list").html(""),$("#wifi_scan_btn").html("Scanning..."),$("#wifi_scan_btn").attr("onclick",""),Socket.send(JSON.stringify({"request-type":"wifi_ssid_scan"}))}function wifi_connect(){ssid=$("#wifi_ssid").val(),psk=$("#wifi_password").val(),""!=ssid&&null!=ssid?""!=psk&&null!=psk?($("#loading_model_body").html("Connecting to WiFi..."),loading_alert.show(),Socket.send(JSON.stringify({"request-type":"connect_wifi",wifi_ssid:ssid,wifi_pass:psk})),setTimeout(function(){window.location.replace(hostname_url)},1e4)):alert("Invalid password."):alert("Invalid SSID.")}function wifi_ap_mode(){$("#promptModalLabel").html("Access Point"),$("#prompt_body").html("Are you sure you want to switch to access point mode ?"),promptModal.show(),$("#promptModelProceed").click(function(){promptModal.hide(),$.get("/username",function(e){Socket.send(JSON.stringify({"request-type":"wifi_ap_mode"})),alert('Switched to AP mode.<br />Connect the wifi to "'+e+'" access point.'),setTimeout(function(){window.location.replace(hostname_url)},1e4)})})}function set_username(e){""!=e&&Socket.send(JSON.stringify({"request-type":"set_username",val:e}))}function isJSON(e){try{return JSON.parse(e)&&!!e}catch(e){return!1}}function update_wifi_ssid(e){$("#wifi_ssid").attr("value",e)}function init_events(){var e=new EventSource("/rawEvents");e.addEventListener("open",function(e){console.log("Events Connected")},!1),e.addEventListener("error",function(e){e.target.readyState!=EventSource.OPEN&&console.log("Events Disconnected")},!1),e.addEventListener("message",function(e){},!1),e.addEventListener("RAW_DATA",function(e){if(t=JSON.parse(e.data),lastEventTimestamp!=t.millis){lastEventTimestamp=t.millis;var t=t.data;if(""!=t){Socket.send(JSON.stringify({"request-type":"send_akn",akn:1})),file_data+=t,file_size_string=get_string_size(file_data),$("#chunk_ratio").html("("+current_packet+" / "+total_packets+") "+file_size_string+" Received"),current_packet+=1;var n=current_packet/total_packets*100;$("#file_upload_progress_bar").css("width",n+"%")}}}),e.addEventListener("RAM_DATA",function(e){var t=JSON.parse(e.data);if(""!=t){var n=parseInt(t.free_heap),a=parseInt(t.heap_size),o=Math.round((a-n)/a*100);$("#ram_ratio").html("<b>"+o+"%</b> ("+n+"/"+a+")"),$("#heap_progress_bar").removeClass("bg-success"),$("#heap_progress_bar").removeClass("bg-warning"),$("#heap_progress_bar").removeClass("bg-danger"),o<30&&$("#heap_progress_bar").addClass("bg-success"),o>30&&o<=70&&$("#heap_progress_bar").addClass("bg-warning"),o>70&&$("#heap_progress_bar").addClass("bg-danger"),$("#heap_progress_bar").css("width",o+"%")}}),e.addEventListener("DEBUG",function(e){var t=JSON.parse(e.data);if(lastDebugEventTimestamp!=t.millis&&(lastDebugEventTimestamp=t.millis,t=t.data,""!=t)){const e=new Date;let n=e.getTime();$("#debug_textarea").prepend(n+" > "+t+"\n")}})}function get_string_size(e){const t=e=>new Blob([e]).size;var n,a=t(e);return n=a/1024<1?a.toFixed(2)+" Bytes":a/1024/1024<1?(a/1204).toFixed(2)+" KB":(a/1204/1024).toFixed(2)+" MB",n}function init_socket(){console.log("Initilizing web sockets."),Socket=new WebSocket("ws://"+window.location.hostname+":"+window.location.port+"/ws"),Socket.onmessage=function(e){try{var t=JSON.parse(e.data),n=t.response_type;if("stop_transmission"==n&&stop_file_transfer_mode(),"wifi_scan"==n){$("#wifi_scan_btn").html("Scan SSID"),$("#wifi_scan_btn").attr("onclick","scan_ssid()");var a=t.SSID,o="";for(i in a){var i=a[i],s=2*(i.rssi+100),r="";s>=80?r="list-group-item-success":s>=60?r="list-group-item-primary":s>=40?r="list-group-item-warning":s<40&&(r="list-group-item-danger"),o+='<li class="list-group-item '+r+' d-flex justify-content-between align-items-center">            <a href="#wifi_password" onclick="update_wifi_ssid(\''+i.ssid+"')\">"+i.ssid+"</a></li>"}$("#wifi_ssid_list").html(o)}if("alert"==n){var l=t.alert_msg;alert(l)}if("lora_rx"==n){t=JSON.parse(t.lora_msg),Socket.send(JSON.stringify({"request-type":"send_akn",akn:1}));var c=t.name,_=(t=JSON.parse(t.data),t.pack_type);"msg"==_&&(l=t.data,$("#lora_rx_msg").prepend("<li class='list-group-item'>"+c+" : "+l+"</li>")),"action"==_&&(action=t.data,"enable_file_tx_mode"==action?(total_packets=t.total_packets,file_size=t.size,file_name=t.name,time=t.time,current_packet=0,$("#file_upload_progress_bar").addClass("bg-success"),$("#rec_info").html("Total "+total_packets+" file chunks will be recieved.<br />Total Size: <b>"+file_size+"</b><br />File Name: <b>"+file_name+"</b><br />Estimated min time <b>"+time+"</b>"),start_file_transfer_mode()):"disable_file_tx_mode"==action?stop_file_transfer_mode():"sos"==action&&alert("User "+c+" has sent a SOS request."))}"set_uname"==n&&$("#username").val(t.uname),"set_sync_word"==n&&set_sync_word(t.value)}catch(e){console.log(e)}},Socket.onopen=function(e){console.log("Connected to web sockets..."),setTimeout(function(){loading_alert.hide()},1e3),dashboard()},Socket.onclose=function(e){$("#loading_model_body").html("Connecting..."),loading_alert.show(),console.log("Connection to websockets closed...."),setTimeout(function(){console.log("Retrying websocket connection...."),init_socket()},1e3)},Socket.onerror=function(e){console.log("Error in websockets"+e)}}function block_inputs(e){e?$(".lora_transmission").attr("disabled","true"):$(".lora_transmission").removeAttr("disabled")}function set_lora_to_serial(e){block_inputs(e),Socket.send(JSON.stringify({"request-type":"set_serial_mode",value:e}))}function set_freq_range(e){$("#selected_lora_freq").html(e)}function set_tx_power(e){$("#selected_lora_tx_power").html(e)}function set_spreading_factor(e){$("#selected_lora_spreading_factor").html(e)}function set_coding_rate(e){$("#selected_lora_coding_rate").html(e)}function reset_progress_bar(){$("#file_upload_progress_bar").css("width","0%")}function stop_broadcast(){stop_file_transfer_mode()}function dataURItoBlob(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(t.length),o=new Uint8Array(a),i=0;i<t.length;i++)o[i]=t.charCodeAt(i);return new Blob([a],{type:n})}function file_broadcast(){if(transmission)return;const e=$("#broadcastFile").prop("files")[0],t=new FileReader;t.readAsDataURL(e),t.onload=function(n){function a(e){if(e<o.length&&transmission){function t(){e+=i;var t=Math.abs(e/o.length*100);$("#file_upload_progress_bar").css("width",t+"%"),setTimeout(()=>{a(e)},s)}function n(){stop_broadcast(),tx_msg={pack_type:"action",data:"disable_file_tx_mode"},$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done(function(e){1==e.akn&&stop_broadcast()}).fail(function(e){})}var r=0;uploadChunk(o.slice(e,e+i),t,()=>{setTimeout(()=>{r<4?(r++,t()):n()},1e3)})}else stop_broadcast(),tx_msg={pack_type:"action",data:"disable_file_tx_mode"},$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done(function(e){1==e.akn&&stop_broadcast()}).fail(function(e){})}const o=t.result,i=parseInt($("#chunk_size").val()),s=parseInt($("#wait_time").val());if(file_data="",file_name=e.name,i>200||i<0)return void alert("packet size should be between 1-200");if(s<10)return void alert("Wait time should be greater than 10 ms");file_size_string=get_string_size(o);const r=Math.floor(o.length/i);var l;l=s<500?Math.abs(.5*r):Math.abs(r*(s/1e3));var c=Math.floor(l/3600),_=Math.floor(l%3600/60),d=Math.floor(l%3600%60);$("#chunk_ratio").html("Total <b>"+r+"</b> file chunks will be transmitted.<br>Total Size <b>"+file_size_string+"</b>.<br>Estimated min time <b>"+c+":"+_+":"+d+"</b>."),$("#file_upload_progress_bar").removeClass("bg-success"),setTimeout(()=>{tx_msg={pack_type:"action",data:"enable_file_tx_mode",total_packets:r,size:file_size_string,name:file_name,time:c+":"+_+":"+d},$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done(function(e){1==e.akn&&(start_file_transfer_mode(),setTimeout(()=>{a(0)},2e3))}).fail(function(e){})},2e3)},t.onerror=function(e){}}function uploadChunk(e,t,n){file_data+=e,$.post("/send_raw",{data:e}).done(function(){t()}).fail(function(){n()})}function start_file_transfer_mode(){transmission=!0,file_data="",block_inputs(transmission)}function stop_file_transfer_mode(){transmission&&alert("Transmission Stopped/finished."),transmission=!1,block_inputs(transmission)}var hostname_url,loading_alert,promptModal,alertModel;$(document).ready(function(){init_socket(),init_events(),get_hostname(),promptModal=new bootstrap.Modal($("#promptModal"),{}),alertModel=new bootstrap.Modal($("#alertModal"),{}),loading_alert=new bootstrap.Modal($("#loadingModal"),{}),$("#loading_model_body").html("Connecting..."),loading_alert.show(),window.onbeforeunload=function(){return"Are you sure you want to leave?"}}),$("#myModal").on("shown.bs.modal",function(){$("#myInput").trigger("focus")});const JSONToFile=(e,t)=>{const n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.download=`${t}.json`,o.click(),URL.revokeObjectURL(a)};var total_packets=0,current_packet=0,file_data="",file_name="",lastEventTimestamp=0,lastDebugEventTimestamp=0,transmission=!1;const downloadFile=()=>{if(transmission)return void alert("File transfer in progress.");const e=document.createElement("a"),t=dataURItoBlob(file_data);e.href=URL.createObjectURL(t),e.download=""==file_name?"Voyager_Download":file_name,e.click(),URL.revokeObjectURL(e.href)};