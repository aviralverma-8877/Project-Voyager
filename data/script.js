var hostname_url,loading_alert,promptModal,alertModel;function set_sync_word(t){$.get("/config/lora_config.json",(function(t){$("#sync_word").val(t.SyncWord)}))}function generate_sync_word(){for(var t=1;t<256;t++)$("#sync_word").append(new Option(t,t))}function get_username(){Socket.send(JSON.stringify({"request-type":"get_username"}))}function send_lora(t){""!=t&&(tx_msg={pack_type:"msg",data:t},$("#lora_msg").val(""),$("#lora_msg").attr("readonly",!0),$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done((function(e){$("#lora_msg").attr("readonly",!1),1==e.akn&&$("#lora_rx_msg").prepend("<li class='list-group-item'>"+e.username+" : "+t+"</li>")})).fail((function(t){$("#lora_msg").attr("readonly",!1)})))}function restart(){$("#promptModalLabel").html("Device Restart"),$("#prompt_body").html("Are you sure you want to restart the device"),promptModal.show(),$("#promptModelProceed").click((function(){promptModal.hide(),Socket.send(JSON.stringify({"request-type":"restart_device"}))}))}function get_hostname(){$.get("hostname",(function(t){hostname_url="http://"+t+".local/",$("#project_title").attr("href",hostname_url)}))}function dashboard(){$(".nav-link").removeClass("active"),$("#navbar-dashboard").addClass("active"),$.get("dashboard.html",(function(t){$("#main_content").html(t);var e=transmission;$.get("/config/lora_serial.json",(function(t){$("#lora_to_serial").attr("checked",t.lora_serial),block_inputs(e=e||t.lora_serial),setTimeout((function(){get_username(),set_sync_word()}),10)}))}))}function file_transfer(){$.get("file_transfer.html",(function(t){$("#main_content").html(t);var e=transmission;$.get("/config/lora_serial.json",(function(t){block_inputs(e=e||t.lora_serial)}))}))}function wifi(){$(".nav-link").removeClass("active"),$("#navbar-wifi").addClass("active"),$.get("wifi.html",(function(t){$("#main_content").html(t),block_inputs(transmission),$.get("/config/wifi_config.json",(function(t){$("#wifi_ssid_name").html(t.wifi_ssid)}))}))}function set_mqtt_enabled(t){$("#mqtt_enabled").attr("checked",t),t?$(".mqtt_enabled").removeAttr("disabled"):($(".mqtt_enabled").attr("disabled","true"),$("#mqtt_host").val(""),$("#mqtt_port").val(""),$("#mqtt_uname").val(""),$("#mqtt_password").val(""))}function set_mqtt_auth(t){$("#mqtt_auth").attr("checked",t),t?$(".mqtt_auth").removeAttr("disabled"):($(".mqtt_auth").attr("disabled","true"),$("#mqtt_uname").val(""),$("#mqtt_password").val(""))}function mqtt(){$(".nav-link").removeClass("active"),$("#navbar-mqtt").addClass("active"),$.get("mqtt.html",(function(t){$("#main_content").html(t),$.get("/config/mqtt_config.json",(function(t){$("#mqtt_enabled").attr("checked",t.mqtt_enabled),$("#mqtt_host").val(t.host),$("#mqtt_port").val(t.port),$("#mqtt_auth").attr("checked",t.auth),set_mqtt_enabled(t.mqtt_enabled),set_mqtt_auth(t.auth),t.auth&&($("#mqtt_uname").val(t.username),$("#mqtt_password").val(t.password))}))}))}function save_mqtt(){enable=$("#mqtt_enabled").is(":checked")>0,host=$("#mqtt_host").val(),port=$("#mqtt_port").val(),auth=$("#mqtt_auth").is(":checked")>0,uname=$("#mqtt_uname").val(),pass=$("#mqtt_password").val(),$.get("/config/mqtt_config.json",(function(t){t.mqtt_enabled=enable,t.host=host,t.port=port,t.auth=auth,t.username=uname,t.password=pass,Socket.send(JSON.stringify({"request-type":"set_mqtt_config",val:JSON.stringify(t)})),alert("MQTT config saved.<br>New settings will be applied after reboot.")}))}function save_lora_config(){$.get("/config/lora_config.json",(function(t){freq=$("#freq_range").val(),tx_power=$("#tx_power_range").val(),s_fact=$("#spreading_factor").val(),bandwidth=$("#bandwidth").val(),coding_rate=$("#coding_rate").val(),sync_word=$("#sync_word").val(),t.freq=parseInt(1e6*freq),t.TxPower=parseInt(tx_power),t.SpreadingFactor=parseInt(s_fact),t.SignalBandwidth=parseInt(bandwidth),t.CodingRate4=parseInt(coding_rate),t.SyncWord=parseInt(sync_word),Socket.send(JSON.stringify({"request-type":"set_lora_config",val:JSON.stringify(t)}))}))}function update_lora_config_from_file(){const t=$("#LoraConfigFile").prop("files")[0],e=new FileReader;e.readAsText(t),e.onload=function(t){try{lora_config=JSON.parse(e.result),$("#LoraConfigFile").val(""),set_lora_config(lora_config),alert("Settings applied.<br>Press save to apply.")}catch(t){alert("Invalid file input.")}}}function download_lora_config(){$.get("/config/lora_config.json",(function(t){freq=$("#freq_range").val(),tx_power=$("#tx_power_range").val(),s_fact=$("#spreading_factor").val(),bandwidth=$("#bandwidth").val(),coding_rate=$("#coding_rate").val(),sync_word=$("#sync_word").val(),t.freq=parseInt(1e6*freq),t.TxPower=parseInt(tx_power),t.SpreadingFactor=parseInt(s_fact),t.SignalBandwidth=parseInt(bandwidth),t.CodingRate4=parseInt(coding_rate),t.SyncWord=parseInt(sync_word),JSONToFile(t,"project_voyager_lora_config.json")}))}$(document).ready((function(){init_socket(),init_events(),get_hostname(),promptModal=new bootstrap.Modal($("#promptModal"),{}),alertModel=new bootstrap.Modal($("#alertModal"),{}),loading_alert=new bootstrap.Modal($("#loadingModal"),{}),$("#loading_model_body").html("Connecting..."),loading_alert.show(),window.onbeforeunload=function(){return"Are you sure you want to leave?"}})),$("#myModal").on("shown.bs.modal",(function(){$("#myInput").trigger("focus")}));const JSONToFile=(t,e)=>{const a=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=URL.createObjectURL(a),o=document.createElement("a");o.href=n,o.download=`${e}.json`,o.click(),URL.revokeObjectURL(n)};function lora(){$(".nav-link").removeClass("active"),$("#navbar-lora").addClass("active"),$.get("lora.html",(function(t){$("#main_content").html(t),block_inputs(transmission),$.get("/config/lora_config.json",(function(t){generate_sync_word(),$("#freq_range").val(t.freq/1e6),$("#selected_lora_freq").html(t.freq/1e6),$("#tx_power_range").val(t.TxPower),$("#selected_lora_tx_power").html(t.TxPower),$("#spreading_factor").val(t.SpreadingFactor),$("#selected_lora_spreading_factor").html(t.SpreadingFactor),$("#bandwidth").val(t.SignalBandwidth),$("#coding_rate").val(t.CodingRate4),$("#selected_lora_coding_rate").html(t.CodingRate4),$("#sync_word").val(t.SyncWord),$.get("/config/config_list.json",(function(t){t.forEach((t=>{$("#lora_config").append('<option value="'+t.value+'">'+t.name+"</option>")}))}))}))}))}function set_lora_config(t){generate_sync_word(),$("#freq_range").val(t.freq/1e6),$("#selected_lora_freq").html(t.freq/1e6),$("#tx_power_range").val(t.TxPower),$("#selected_lora_tx_power").html(t.TxPower),$("#spreading_factor").val(t.SpreadingFactor),$("#selected_lora_spreading_factor").html(t.SpreadingFactor),$("#bandwidth").val(t.SignalBandwidth),$("#coding_rate").val(t.CodingRate4),$("#selected_lora_coding_rate").html(t.CodingRate4),$("#sync_word").val(t.SyncWord)}function load_lora_config(t){""!=t&&$.get("/config/"+t,(function(t){set_lora_config(t)}))}function update(){$(".nav-link").removeClass("active"),$("#navbar-update").addClass("active"),$.get("update",(function(t){$("#main_content").html(t),block_inputs(transmission)}))}function alert(t){$("#alert_body").html(t),alertModel.show()}function reset(){$("#promptModalLabel").html("Device Reset"),$("#prompt_body").html("Are you sure you want to reset the device ?"),promptModal.show(),$("#promptModelProceed").click((function(){promptModal.hide(),Socket.send(JSON.stringify({"request-type":"reset_device"})),setTimeout((function(){window.location.replace(hostname_url)}),1e4)}))}function scan_ssid(){$("#wifi_ssid_list").html(""),$("#wifi_scan_btn").html("Scanning..."),$("#wifi_scan_btn").attr("onclick",""),Socket.send(JSON.stringify({"request-type":"wifi_ssid_scan"}))}function wifi_connect(){ssid=$("#wifi_ssid").val(),psk=$("#wifi_password").val(),""!=ssid&&null!=ssid?""!=psk&&null!=psk?($("#loading_model_body").html("Connecting to WiFi..."),loading_alert.show(),Socket.send(JSON.stringify({"request-type":"connect_wifi",wifi_ssid:ssid,wifi_pass:psk})),setTimeout((function(){window.location.replace(hostname_url)}),1e4)):alert("Invalid password."):alert("Invalid SSID.")}function wifi_ap_mode(){$("#promptModalLabel").html("Access Point"),$("#prompt_body").html("Are you sure you want to switch to access point mode ?"),promptModal.show(),$("#promptModelProceed").click((function(){promptModal.hide(),$.get("/username",(function(t){Socket.send(JSON.stringify({"request-type":"wifi_ap_mode"})),alert('Switched to AP mode.<br />Connect the wifi to "'+t+'" access point.'),setTimeout((function(){window.location.replace(hostname_url)}),1e4)}))}))}function set_username(t){""!=t&&Socket.send(JSON.stringify({"request-type":"set_username",val:t}))}function isJSON(t){try{return JSON.parse(t)&&!!t}catch(t){return!1}}function update_wifi_ssid(t){$("#wifi_ssid").attr("value",t)}var total_packets=0,current_packet=0,file_data="",file_name="",lastEventTimestamp=0,lastDebugEventTimestamp=0;function init_events(){var t=new EventSource("/rawEvents");t.addEventListener("open",(function(t){}),!1),t.addEventListener("error",(function(t){t.target.readyState,EventSource.OPEN}),!1),t.addEventListener("message",(function(t){}),!1),t.addEventListener("RAW_DATA",(function(t){if(e=JSON.parse(t.data),lastEventTimestamp!=e.millis){lastEventTimestamp=e.millis;var e=e.data;if(""!=e){Socket.send(JSON.stringify({"request-type":"send_akn",akn:1})),file_data+=e,file_size_string=get_string_size(file_data),$("#chunk_ratio").html("("+current_packet+" / "+total_packets+") "+file_size_string+" Received");var a=(current_packet+=1)/total_packets*100;$("#file_upload_progress_bar").css("width",a+"%")}}})),t.addEventListener("RAM_DATA",(function(t){var e=JSON.parse(t.data);if(""!=e){var a=parseInt(e.free_heap),n=parseInt(e.heap_size),o=Math.round((n-a)/n*100);$("#ram_ratio").html("<b>"+o+"%</b> ("+a+"/"+n+")"),$("#heap_progress_bar").removeClass("bg-success"),$("#heap_progress_bar").removeClass("bg-warning"),$("#heap_progress_bar").removeClass("bg-danger"),o<30&&$("#heap_progress_bar").addClass("bg-success"),o>30&&o<=70&&$("#heap_progress_bar").addClass("bg-warning"),o>70&&$("#heap_progress_bar").addClass("bg-danger"),$("#heap_progress_bar").css("width",o+"%")}})),t.addEventListener("DEBUG",(function(t){var e=JSON.parse(t.data);if(lastDebugEventTimestamp!=e.millis&&(lastDebugEventTimestamp=e.millis,""!=(e=e.data))){let t=(new Date).getTime();$("#debug_textarea").prepend(t+" > "+e+"\n")}}))}function get_string_size(t){var e=new Blob([t]).size;return e/1024<1?e.toFixed(2)+" Bytes":e/1024/1024<1?(e/1204).toFixed(2)+" KB":(e/1204/1024).toFixed(2)+" MB"}function init_socket(){Socket=new WebSocket("ws://"+window.location.hostname+":"+window.location.port+"/ws"),Socket.onmessage=function(t){try{var e=(l=JSON.parse(t.data)).response_type;if("stop_transmission"==e&&stop_file_transfer_mode(),"wifi_scan"==e){$("#wifi_scan_btn").html("Scan SSID"),$("#wifi_scan_btn").attr("onclick","scan_ssid()");var a=l.SSID,n="";for(o in a){var o=a[o],i=2*(o.rssi+100),s="";i>=80?s="list-group-item-success":i>=60?s="list-group-item-primary":i>=40?s="list-group-item-warning":i<40&&(s="list-group-item-danger"),n+='<li class="list-group-item '+s+' d-flex justify-content-between align-items-center">            <a href="#wifi_password" onclick="update_wifi_ssid(\''+o.ssid+"')\">"+o.ssid+"</a></li>"}$("#wifi_ssid_list").html(n)}if("alert"==e){var r=l.alert_msg;alert(r)}if("lora_rx"==e){l=JSON.parse(l.lora_msg),Socket.send(JSON.stringify({"request-type":"send_akn",akn:1}));var l,_=l.name,c=(l=JSON.parse(l.data)).pack_type;"msg"==c&&(r=l.data,$("#lora_rx_msg").prepend("<li class='list-group-item'>"+_+" : "+r+"</li>")),"action"==c&&(action=l.data,"enable_file_tx_mode"==action?(total_packets=l.total_packets,file_size=l.size,file_name=l.name,time=l.time,current_packet=0,$("#file_upload_progress_bar").addClass("bg-success"),$("#rec_info").html("Total "+total_packets+" file chunks will be recieved.<br />Total Size: <b>"+file_size+"</b><br />File Name: <b>"+file_name+"</b><br />Estimated min time <b>"+time+"</b>"),start_file_transfer_mode()):"disable_file_tx_mode"==action?stop_file_transfer_mode():"sos"==action&&alert("User "+_+" has sent a SOS request."))}"set_uname"==e&&$("#username").val(l.uname),"set_sync_word"==e&&set_sync_word(l.value)}catch(t){}},Socket.onopen=function(t){setTimeout((function(){loading_alert.hide()}),1e3),dashboard()},Socket.onclose=function(t){$("#loading_model_body").html("Connecting..."),loading_alert.show(),setTimeout((function(){init_socket()}),1e3)},Socket.onerror=function(t){}}function block_inputs(t){t?$(".lora_transmission").attr("disabled","true"):$(".lora_transmission").removeAttr("disabled")}function set_lora_to_serial(t){block_inputs(t),Socket.send(JSON.stringify({"request-type":"set_serial_mode",value:t}))}function set_freq_range(t){$("#selected_lora_freq").html(t)}function set_tx_power(t){$("#selected_lora_tx_power").html(t)}function set_spreading_factor(t){$("#selected_lora_spreading_factor").html(t)}function set_coding_rate(t){$("#selected_lora_coding_rate").html(t)}function reset_progress_bar(){$("#file_upload_progress_bar").css("width","0%")}var transmission=!1;function stop_broadcast(){stop_file_transfer_mode()}function dataURItoBlob(t){for(var e=atob(t.split(",")[1]),a=t.split(",")[0].split(":")[1].split(";")[0],n=new ArrayBuffer(e.length),o=new Uint8Array(n),i=0;i<e.length;i++)o[i]=e.charCodeAt(i);return new Blob([n],{type:a})}const downloadFile=()=>{if(transmission)return void alert("File transfer in progress.");const t=document.createElement("a"),e=dataURItoBlob(file_data);t.href=URL.createObjectURL(e),t.download=""==file_name?"Voyager_Download":file_name,t.click(),URL.revokeObjectURL(t.href)};function file_broadcast(){if(transmission)return;const t=$("#broadcastFile").prop("files")[0],e=new FileReader;e.readAsDataURL(t),e.onload=function(a){const n=e.result,o=parseInt($("#chunk_size").val()),i=parseInt($("#wait_time").val());if(file_data="",file_name=t.name,o>200||o<0)return void alert("packet size should be between 1-200");if(i<10)return void alert("Wait time should be greater than 10 ms");file_size_string=get_string_size(n);const s=Math.floor(n.length/o);var r;r=i<500?Math.abs(.5*s):Math.abs(s*(i/1e3));var l=Math.floor(r/3600),_=Math.floor(r%3600/60),c=Math.floor(r%3600%60);function d(t){if(t<n.length&&transmission){function e(){t+=o;var e=Math.abs(t/n.length*100);$("#file_upload_progress_bar").css("width",e+"%"),setTimeout((()=>{d(t)}),i)}var a=0;uploadChunk(n.slice(t,t+o),e,(()=>{setTimeout((()=>{a<4?(a++,e()):(stop_broadcast(),tx_msg={pack_type:"action",data:"disable_file_tx_mode"},$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done((function(t){1==t.akn&&stop_broadcast()})).fail((function(t){})))}),1e3)}))}else stop_broadcast(),tx_msg={pack_type:"action",data:"disable_file_tx_mode"},$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done((function(t){1==t.akn&&stop_broadcast()})).fail((function(t){}))}$("#chunk_ratio").html("Total <b>"+s+"</b> file chunks will be transmitted.<br>Total Size <b>"+file_size_string+"</b>.<br>Estimated min time <b>"+l+":"+_+":"+c+"</b>."),$("#file_upload_progress_bar").removeClass("bg-success"),setTimeout((()=>{tx_msg={pack_type:"action",data:"enable_file_tx_mode",total_packets:s,size:file_size_string,name:file_name,time:l+":"+_+":"+c},$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done((function(t){1==t.akn&&(start_file_transfer_mode(),setTimeout((()=>{d(0)}),2e3))})).fail((function(t){}))}),2e3)},e.onerror=function(t){}}function uploadChunk(t,e,a){file_data+=t,$.post("/send_raw",{data:t}).done((function(){e()})).fail((function(){a()}))}function start_file_transfer_mode(){file_data="",block_inputs(transmission=!0)}function stop_file_transfer_mode(){transmission&&alert("Transmission Stopped/finished."),block_inputs(transmission=!1)}