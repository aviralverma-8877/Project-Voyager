var hostname_url,loading_alert,promptModal,alertModel;function set_sync_word(e){$.get("/config/lora_config.json",function(e){$("#sync_word").val(e.SyncWord)})}function generate_sync_word(){for(var e=1;e<256;e++)$("#sync_word").append(new Option(e,e))}function get_username(){Socket.send(JSON.stringify({"request-type":"get_username"}))}function send_lora(t){""!=t&&(tx_msg={pack_type:"msg",data:t},$("#lora_msg").val(""),$("#lora_msg").attr("readonly",!0),$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done(function(e){$("#lora_msg").attr("readonly",!1),1==e.akn&&$("#lora_rx_msg").prepend("<li class='list-group-item'>"+e.username+" : "+t+"</li>")}).fail(function(e){$("#lora_msg").attr("readonly",!1)}))}function restart(){$("#promptModalLabel").html("Device Restart"),$("#prompt_body").html("Are you sure you want to restart the device"),promptModal.show(),$("#promptModelProceed").click(function(){promptModal.hide(),Socket.send(JSON.stringify({"request-type":"restart_device"}))})}function get_hostname(){$.get("hostname",function(e){hostname_url="http://"+e+".local/",$("#project_title").attr("href",hostname_url)})}function dashboard(){$(".nav-link").removeClass("active"),$("#navbar-dashboard").addClass("active"),$.get("dashboard.html",function(e){$("#main_content").html(e);var t=transmission;$.get("/config/lora_serial.json",function(e){$("#lora_to_serial").attr("checked",e.lora_serial),block_inputs(t=t||e.lora_serial),setTimeout(function(){get_username(),set_sync_word()},10)})})}function file_transfer(){$.get("file_transfer.html",function(e){$("#main_content").html(e);var t=transmission;$.get("/config/lora_serial.json",function(e){block_inputs(t=t||e.lora_serial)})})}function wifi(){$(".nav-link").removeClass("active"),$("#navbar-wifi").addClass("active"),$.get("wifi.html",function(e){$("#main_content").html(e),block_inputs(transmission),$.get("/config/wifi_config.json",function(e){$("#wifi_ssid_name").html(e.wifi_ssid)})})}function save_lora_config(){$.get("/config/lora_config.json",function(e){freq=$("#freq_range").val(),tx_power=$("#tx_power_range").val(),s_fact=$("#spreading_factor").val(),bandwidth=$("#bandwidth").val(),coding_rate=$("#coding_rate").val(),sync_word=$("#sync_word").val(),e.freq=parseInt(1e6*freq),e.TxPower=parseInt(tx_power),e.SpreadingFactor=parseInt(s_fact),e.SignalBandwidth=parseInt(bandwidth),e.CodingRate4=parseInt(coding_rate),e.SyncWord=parseInt(sync_word),Socket.send(JSON.stringify({"request-type":"set_lora_config",val:JSON.stringify(e)}))})}function update_lora_config_from_file(){var e=$("#LoraConfigFile").prop("files")[0];const t=new FileReader;t.readAsText(e),t.onload=function(e){try{lora_config=JSON.parse(t.result),$("#LoraConfigFile").val(""),set_lora_config(lora_config),alert("Settings applied.<br>Press save to apply.")}catch(e){alert("Invalid file input.")}}}function download_lora_config(){$.get("/config/lora_config.json",function(e){freq=$("#freq_range").val(),tx_power=$("#tx_power_range").val(),s_fact=$("#spreading_factor").val(),bandwidth=$("#bandwidth").val(),coding_rate=$("#coding_rate").val(),sync_word=$("#sync_word").val(),e.freq=parseInt(1e6*freq),e.TxPower=parseInt(tx_power),e.SpreadingFactor=parseInt(s_fact),e.SignalBandwidth=parseInt(bandwidth),e.CodingRate4=parseInt(coding_rate),e.SyncWord=parseInt(sync_word),JSONToFile(e,"project_voyager_lora_config.json")})}$(document).ready(function(){init_socket(),init_events(),get_hostname(),promptModal=new bootstrap.Modal($("#promptModal"),{}),alertModel=new bootstrap.Modal($("#alertModal"),{}),loading_alert=new bootstrap.Modal($("#loadingModal"),{}),$("#loading_model_body").html("Connecting..."),loading_alert.show(),window.onbeforeunload=function(){return"Are you sure you want to leave?"}}),$("#myModal").on("shown.bs.modal",function(){$("#myInput").trigger("focus")});const JSONToFile=(e,t)=>{var e=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),e=URL.createObjectURL(e),n=document.createElement("a");n.href=e,n.download=t+".json",n.click(),URL.revokeObjectURL(e)};function lora(){$(".nav-link").removeClass("active"),$("#navbar-lora").addClass("active"),$.get("lora.html",function(e){$("#main_content").html(e),block_inputs(transmission),$.get("/config/lora_config.json",function(e){generate_sync_word(),$("#freq_range").val(e.freq/1e6),$("#selected_lora_freq").html(e.freq/1e6),$("#tx_power_range").val(e.TxPower),$("#selected_lora_tx_power").html(e.TxPower),$("#spreading_factor").val(e.SpreadingFactor),$("#selected_lora_spreading_factor").html(e.SpreadingFactor),$("#bandwidth").val(e.SignalBandwidth),$("#coding_rate").val(e.CodingRate4),$("#selected_lora_coding_rate").html(e.CodingRate4),$("#sync_word").val(e.SyncWord),$.get("/config/config_list.json",function(e){e.forEach(e=>{$("#lora_config").append('<option value="'+e.value+'">'+e.name+"</option>")})})})})}function set_lora_config(e){generate_sync_word(),$("#freq_range").val(e.freq/1e6),$("#selected_lora_freq").html(e.freq/1e6),$("#tx_power_range").val(e.TxPower),$("#selected_lora_tx_power").html(e.TxPower),$("#spreading_factor").val(e.SpreadingFactor),$("#selected_lora_spreading_factor").html(e.SpreadingFactor),$("#bandwidth").val(e.SignalBandwidth),$("#coding_rate").val(e.CodingRate4),$("#selected_lora_coding_rate").html(e.CodingRate4),$("#sync_word").val(e.SyncWord)}function load_lora_config(e){""!=e&&$.get("/config/"+e,function(e){set_lora_config(e)})}function update(){$(".nav-link").removeClass("active"),$("#navbar-update").addClass("active"),$.get("update",function(e){$("#main_content").html(e),block_inputs(transmission)})}function alert(e){$("#alert_body").html(e),alertModel.show()}function reset(){$("#promptModalLabel").html("Device Reset"),$("#prompt_body").html("Are you sure you want to reset the device ?"),promptModal.show(),$("#promptModelProceed").click(function(){promptModal.hide(),Socket.send(JSON.stringify({"request-type":"reset_device"})),setTimeout(function(){window.location.replace(hostname_url)},1e4)})}function scan_ssid(){$("#wifi_ssid_list").html(""),$("#wifi_scan_btn").html("Scanning..."),$("#wifi_scan_btn").attr("onclick",""),Socket.send(JSON.stringify({"request-type":"wifi_ssid_scan"}))}function wifi_connect(){ssid=$("#wifi_ssid").val(),psk=$("#wifi_password").val(),""==ssid||null==ssid?alert("Invalid SSID."):""==psk||null==psk?alert("Invalid password."):($("#loading_model_body").html("Connecting to WiFi..."),loading_alert.show(),Socket.send(JSON.stringify({"request-type":"connect_wifi",wifi_ssid:ssid,wifi_pass:psk})),setTimeout(function(){window.location.replace(hostname_url)},1e4))}function wifi_ap_mode(){$("#promptModalLabel").html("Access Point"),$("#prompt_body").html("Are you sure you want to switch to access point mode ?"),promptModal.show(),$("#promptModelProceed").click(function(){promptModal.hide(),$.get("/username",function(e){Socket.send(JSON.stringify({"request-type":"wifi_ap_mode"})),alert('Switched to AP mode.<br />Connect the wifi to "'+e+'" access point.'),setTimeout(function(){window.location.replace(hostname_url)},1e4)})})}function set_username(e){""!=e&&Socket.send(JSON.stringify({"request-type":"set_username",val:e}))}function isJSON(e){try{return JSON.parse(e)&&!!e}catch(e){return!1}}function update_wifi_ssid(e){$("#wifi_ssid").attr("value",e)}var total_packets=0,current_packet=0,file_data="",file_name="",lastEventTimestamp=0,lastDebugEventTimestamp=0;function init_events(){var e=new EventSource("/rawEvents");e.addEventListener("open",function(e){console.log("Events Connected")},!1),e.addEventListener("error",function(e){e.target.readyState!=EventSource.OPEN&&console.log("Events Disconnected")},!1),e.addEventListener("message",function(e){},!1),e.addEventListener("RAW_DATA",function(e){var e=JSON.parse(e.data);lastEventTimestamp!=e.millis&&(lastEventTimestamp=e.millis,""!=(e=e.data))&&(Socket.send(JSON.stringify({"request-type":"send_akn",akn:1})),file_size_string=get_string_size(file_data+=e),$("#chunk_ratio").html("("+current_packet+" / "+total_packets+") "+file_size_string+" Received"),e=(current_packet+=1)/total_packets*100,$("#file_upload_progress_bar").css("width",e+"%"))}),e.addEventListener("RAM_DATA",function(e){var t,n,e=JSON.parse(e.data);""!=e&&(t=parseInt(e.free_heap),e=parseInt(e.heap_size),n=Math.round((e-t)/e*100),$("#ram_ratio").html("<b>"+n+"%</b> ("+t+"/"+e+")"),$("#heap_progress_bar").removeClass("bg-success"),$("#heap_progress_bar").removeClass("bg-warning"),$("#heap_progress_bar").removeClass("bg-danger"),n<30&&$("#heap_progress_bar").addClass("bg-success"),30<n&&n<=70&&$("#heap_progress_bar").addClass("bg-warning"),70<n&&$("#heap_progress_bar").addClass("bg-danger"),$("#heap_progress_bar").css("width",n+"%"))}),e.addEventListener("DEBUG",function(e){var t,e=JSON.parse(e.data);lastDebugEventTimestamp!=e.millis&&(lastDebugEventTimestamp=e.millis,""!=(e=e.data))&&(t=(new Date).getTime(),$("#debug_textarea").prepend(t+" > "+e+"\n"))})}function get_string_size(e){e=new Blob([e]).size,e=e/1024<1?e.toFixed(2)+" Bytes":e/1024/1024<1?(e/1204).toFixed(2)+" KB":(e/1204/1024).toFixed(2)+" MB";return e}function init_socket(){console.log("Initilizing web sockets."),(Socket=new WebSocket("ws://"+window.location.hostname+":"+window.location.port+"/ws")).onmessage=function(e){try{var t,n,a,o=JSON.parse(e.data),i=o.response_type;if("stop_transmission"==i&&stop_file_transfer_mode(),"wifi_scan"==i){$("#wifi_scan_btn").html("Scan SSID"),$("#wifi_scan_btn").attr("onclick","scan_ssid()");var s=o.SSID,r="";for(l in s){var l=s[l],c=2*(l.rssi+100),_="";80<=c?_="list-group-item-success":60<=c?_="list-group-item-primary":40<=c?_="list-group-item-warning":c<40&&(_="list-group-item-danger"),r+='<li class="list-group-item '+_+' d-flex justify-content-between align-items-center">            <a href="#wifi_password" onclick="update_wifi_ssid(\''+l.ssid+"')\">"+l.ssid+"</a></li>"}$("#wifi_ssid_list").html(r)}"alert"==i&&alert(t=o.alert_msg),"lora_rx"==i&&(o=JSON.parse(o.lora_msg),Socket.send(JSON.stringify({"request-type":"send_akn",akn:1})),n=o.name,"msg"==(a=(o=JSON.parse(o.data)).pack_type)&&(t=o.data,$("#lora_rx_msg").prepend("<li class='list-group-item'>"+n+" : "+t+"</li>")),"action"==a)&&("enable_file_tx_mode"==(action=o.data)?(total_packets=o.total_packets,file_size=o.size,file_name=o.name,time=o.time,current_packet=0,$("#file_upload_progress_bar").addClass("bg-success"),$("#rec_info").html("Total "+total_packets+" file chunks will be recieved.<br />Total Size: <b>"+file_size+"</b><br />File Name: <b>"+file_name+"</b><br />Estimated min time <b>"+time+"</b>"),start_file_transfer_mode()):"disable_file_tx_mode"==action?stop_file_transfer_mode():"sos"==action&&alert("User "+n+" has sent a SOS request.")),"set_uname"==i&&$("#username").val(o.uname),"set_sync_word"==i&&set_sync_word(o.value)}catch(e){console.log(e)}},Socket.onopen=function(e){console.log("Connected to web sockets..."),setTimeout(function(){loading_alert.hide()},1e3),dashboard()},Socket.onclose=function(e){$("#loading_model_body").html("Connecting..."),loading_alert.show(),console.log("Connection to websockets closed...."),setTimeout(function(){console.log("Retrying websocket connection...."),init_socket()},1e3)},Socket.onerror=function(e){console.log("Error in websockets"+e)}}function block_inputs(e){e?$(".lora_transmission").attr("disabled","true"):$(".lora_transmission").removeAttr("disabled")}function set_lora_to_serial(e){block_inputs(e),Socket.send(JSON.stringify({"request-type":"set_serial_mode",value:e}))}function set_freq_range(e){$("#selected_lora_freq").html(e)}function set_tx_power(e){$("#selected_lora_tx_power").html(e)}function set_spreading_factor(e){$("#selected_lora_spreading_factor").html(e)}function set_coding_rate(e){$("#selected_lora_coding_rate").html(e)}function reset_progress_bar(){$("#file_upload_progress_bar").css("width","0%")}var transmission=!1;function stop_broadcast(){stop_file_transfer_mode()}function dataURItoBlob(e){for(var t=atob(e.split(",")[1]),e=e.split(",")[0].split(":")[1].split(";")[0],n=new ArrayBuffer(t.length),a=new Uint8Array(n),o=0;o<t.length;o++)a[o]=t.charCodeAt(o);return new Blob([n],{type:e})}const downloadFile=()=>{var e,t;transmission?alert("File transfer in progress."):(e=document.createElement("a"),t=dataURItoBlob(file_data),e.href=URL.createObjectURL(t),e.download=""==file_name?"Voyager_Download":file_name,e.click(),URL.revokeObjectURL(e.href))};function file_broadcast(){if(!transmission){const _=$("#broadcastFile").prop("files")[0],d=new FileReader;d.readAsDataURL(_),d.onload=function(e){const a=d.result,o=parseInt($("#chunk_size").val()),i=parseInt($("#wait_time").val());if(file_data="",file_name=_.name,200<o||o<0)alert("packet size should be between 1-200");else if(i<10)alert("Wait time should be greater than 10 ms");else{file_size_string=get_string_size(a);const c=Math.floor(a.length/o);var t=i<500?Math.abs(.5*c):Math.abs(c*(i/1e3)),n=Math.floor(t/3600),s=Math.floor(t%3600/60),r=Math.floor(t%3600%60);function l(t){function e(){t+=o;var e=Math.abs(t/a.length*100);$("#file_upload_progress_bar").css("width",e+"%"),setTimeout(()=>{l(t)},i)}var n;t<a.length&&transmission?(n=0,uploadChunk(a.slice(t,t+o),e,()=>{setTimeout(()=>{n<4?(n++,e()):(stop_broadcast(),tx_msg={pack_type:"action",data:"disable_file_tx_mode"},$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done(function(e){1==e.akn&&stop_broadcast()}).fail(function(e){}))},1e3)})):(stop_broadcast(),tx_msg={pack_type:"action",data:"disable_file_tx_mode"},$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done(function(e){1==e.akn&&stop_broadcast()}).fail(function(e){}))}$("#chunk_ratio").html("Total <b>"+c+"</b> file chunks will be transmitted.<br>Total Size <b>"+file_size_string+"</b>.<br>Estimated min time <b>"+n+":"+s+":"+r+"</b>."),$("#file_upload_progress_bar").removeClass("bg-success"),setTimeout(()=>{tx_msg={pack_type:"action",data:"enable_file_tx_mode",total_packets:c,size:file_size_string,name:file_name,time:n+":"+s+":"+r},$.post("/lora_transmit",{data:JSON.stringify(tx_msg)}).done(function(e){1==e.akn&&(start_file_transfer_mode(),setTimeout(()=>{l(0)},2e3))}).fail(function(e){})},2e3)}},d.onerror=function(e){}}}function uploadChunk(e,t,n){file_data+=e,$.post("/send_raw",{data:e}).done(function(){t()}).fail(function(){n()})}function start_file_transfer_mode(){block_inputs(transmission=!(file_data=""))}function stop_file_transfer_mode(){transmission&&alert("Transmission Stopped/finished."),block_inputs(transmission=!1)}